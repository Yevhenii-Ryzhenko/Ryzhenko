pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Yevhenii-Ryzhenko/Ryzhenko.git'
            }
        }
        stage('Install dependencies') {
            steps {
                bat '''
                    rmdir /s /q venv
                    C:\\Users\\yryzh\\AppData\\Local\\Programs\\Python\\Python313\\python.exe -m venv venv
                    call venv\\Scripts\\activate.bat
                    python -m pip install --upgrade pip
                    python -m pip install -r requirements.txt
                '''
            }
        }
        stage('Run tests') {
            steps {
                bat """
                    call venv\\Scripts\\activate.bat
                    pytest -m "${PYTEST_MARK}" --alluredir=allure-results
                """
            }
        }
    }

    post {
        always {
            allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            mail(
                to: "${EMAIL}, ryzhenko.yevhenii@gmail.com",
                  subject: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${currentBuild.currentResult}",
                  body:
                  """<html><body>
                  <p>Hello!</p>
                  <p>Build <b>${env.JOB_NAME} #${env.BUILD_NUMBER}</b> finished with status:
                            <span style="color:${currentBuild.currentResult == 'SUCCESS' ? 'green' : 'red'};">
                            ${currentBuild.currentResult}
                            </span>
                  </p>
                  <div style="border:1px solid #ccc; padding:10px; border-radius:5px;">
                        <p><b>Details:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                        <p><b>Allure report:</b> <a href="${env.BUILD_URL}allure">View the report</a></p>
                  </div>
                  <p><b>Start time:</b> ${new Date(currentBuild.startTimeInMillis)}</p>
                  <p><b>Duration:</b> ${currentBuild.durationString}</p>
                  </body></html>""",
    mimeType: 'text/html'
)
        }
    }
}